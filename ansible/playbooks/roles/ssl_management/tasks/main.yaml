- name: Copy SSL restore script
  ansible.builtin.copy:
    src: restore_ssl.sh
    dest: /tmp/restore_ssl.sh
    mode: '0700'
    owner: root
    group: root

- name: Execute SSL backup (with passphrase from variable)
  ansible.builtin.shell: |
    /tmp/restore_ssl.sh "{{ git_token }}" "{{ root_password }}"
  register: backup_result
  no_log: true 
  changed_when: backup_result.rc == 0

- name: Display backup result
  ansible.builtin.debug:
    msg: "{{ backup_result.stdout }}"
  when: backup_result.stdout != ""

- name: Backup /etc/letsencrypt
  ansible.builtin.command: >
    tar -czf - /etc/letsencrypt | 
    gpg --batch --yes --passphrase "{{ root_password }}" 
    --symmetric --cipher-algo AES256 --output /tmp/ssl-backup.tar.gz.gpg
  args:
    executable: /bin/bash
  tags: backup