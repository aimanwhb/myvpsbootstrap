---
- name: Load kernel modules
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k3s.conf
    content: |
      overlay
      br_netfilter
    owner: root
    group: root
    mode: '0644'

- name: Load modules immediately
  ansible.builtin.shell:
    cmd: |
      modprobe overlay
      modprobe br_netfilter

- name: Configure sysctl for K3s
  ansible.builtin.copy:
    dest: /etc/sysctl.d/k3s.conf
    content: |
      net.bridge.bridge-nf-call-ip6tables = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.ipv4.ip_forward = 1
    owner: root
    group: root
    mode: '0644'

- name: Apply sysctl settings
  ansible.builtin.shell:
    cmd: sysctl --system

- name: Install K3s
  ansible.builtin.shell:
    cmd: |
      curl -sfL https://get.k3s.io | sh -
    creates: /usr/local/bin/k3s
  register: k3s_install

- name: Wait for K3s to be ready
  ansible.builtin.shell:
    cmd: |
      timeout 60 bash -c 'until k3s kubectl get nodes 2>/dev/null; do sleep 2; done'
  when: k3s_install.changed

- name: Verify K3s installation
  ansible.builtin.shell:
    cmd: |
      k3s kubectl get nodes
      echo "K3s version: $(k3s --version)"
  register: k3s_verify

- name: Display K3s status
  ansible.builtin.debug:
    msg: "{{ k3s_verify.stdout_lines }}"

- name: Wait for traefik to be ready
  ansible.builtin.shell:
    cmd: |
      timeout 60 bash -c 'until k3s kubectl -n kube-system get svc traefik 2>/dev/null; do sleep 2; done'

- name: Update traefik from loadbalancer to nodeport type
  ansible.builtin.shell:
    cmd: |
      kubectl -n kube-system patch svc traefik \
      -p '{
        "spec": {
          "type": "NodePort",
          "ports": [
            {
              "name": "http",
              "port": 80,
              "targetPort": 80,
              "nodePort": {{ traefik_nodeport }}
            },
            {
              "name": "https",
              "port": 443,
              "targetPort": 443,
              "nodePort": 30443
            }
          ]
        }
      }'

- name: Ensure .kube directory exists
  ansible.builtin.file:
    path: "/home/{{ item.name }}/.kube"
    state: directory
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: '0700'
  loop: "{{ users }}"

- name: Copy K3s kubeconfig
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "/home/{{ item.name }}/.kube/config"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: '0600'
  loop: "{{ users }}"

- name: Ensure KUBECONFIG is set in .bashrc
  ansible.builtin.lineinfile:
    path: "/home/{{ item.name }}/.bashrc"
    line: 'export KUBECONFIG=/home/{{ item.name }}/.kube/config'
    create: yes
    state: present
  become: true
  become_user: "{{ item.name }}"
  loop: "{{ users }}"

- name: Display nodes to verify setup
  ansible.builtin.command: kubectl get nodes --kubeconfig /home/{{ item.name }}/.kube/config
  loop: "{{ users }}"

- name: Set kubectl alias for all users
  ansible.builtin.copy:
    dest: /etc/profile.d/kubectl.sh
    content: |
      alias k=kubectl
    owner: root
    group: root
    mode: '0755'