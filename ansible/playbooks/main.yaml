---
- name: Bootstrap VPS KVM4
  hosts: local
  become: true
  gather_facts: true
  vars_files:
    - var/vars.yaml

  pre_tasks:
    - name: Set variables from environment
      ansible.builtin.set_fact:
        ROOT_PASSWORD: "{{ lookup('env', 'ROOT_PASSWORD') }}"
        GIT_TOKEN: "{{ lookup('env', 'GIT_TOKEN') }}"
      tags: always

    - name: Validate environment variables
      ansible.builtin.assert:
        that:
          - ROOT_PASSWORD is defined
          - ROOT_PASSWORD != ""
          - GIT_TOKEN is defined
          - GIT_TOKEN != ""
        fail_msg: |
          ‚ùå Missing required environment variables!
          Export them first:
            export ROOT_PASSWORD='your_password'
            export GIT_TOKEN='your_token'
      tags: always
      
  roles:
    # Base system update, packages and services
    - role: base
      tags: ['base']

    # Security hardening (SSH, firewall, fail2ban)
    - role: security
      tags: ['security']

    # User accounts and SSH keys
    - role: users
      tags: ['users']

    # Manage Cert - Apply and Backup
    - role: cert_management
      tags: ['cert_management']

    # Web UI cockpit installation
    - role: panel
      tags: ['panel']

    # K3s and headlamp dashboard installation
    - role: k3s
      tags: ['k3s']